steps:
  - script: |
      set -e
      
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=$(ssh_timeout_s) "$(username)"@"$(publicIP)" '
      source /etc/profile.d/deploy_server.sh

      # Modify environment value so it starts with u and with length of 5
      environment_env=${{parameters.environment_env}}
      buildId=$(Build.BuildId)
      isRelease=${environment_env%%$buildId*}

      if [ -z "${isRelease}" ]
      then 
        environment_prefix="U$(echo $(Build.BuildId) | rev | cut -c1-4 | rev)"
      else
        environment_prefix=${environment_env}
      fi

      environment_rg="${environment_prefix}-EAUS-SAP0-INFRASTRUCTURE"
      
      repo_dir=$HOME/${environment_rg}/sap-hana
      ws_dir=$HOME/Azure_SAP_Automated_Deployment/WORKSPACES/SAP_LANDSCAPE/${environment_rg}
      input=${ws_dir}/${environment_rg}.json

      echo "=== Checkout required branch ${{parameters.branch_name}} ==="
      cd $HOME/${environment_rg}/sap-hana && git checkout ${{parameters.branch_name}}
      
      echo "=== Enter workspace ${ws_dir} ==="
      cd ${ws_dir}

      dir_to_check=${repo_dir}/deploy/terraform/run/sap_landscape
      if [ -d $dir_to_check ] 
      then
        foldername="sap_landscape"
        templatefilename="saplandscape.json"
      else
        foldername="environment"
        templatefilename="environment.json"
      fi

      terraform init -upgrade=true ${repo_dir}/deploy/terraform/run/$foldername/
      terraform refresh -var-file=${input} ${repo_dir}/deploy/terraform/run/$foldername/
      terraform plan -var-file=${input} ${repo_dir}/deploy/terraform/run/$foldername/ > plan_output.log
      cat plan_output.log
      
      if ! grep "No changes\|0 to change, 0 to destroy" plan_output.log; then exit 1; fi;
      '
    displayName: "Validate Environment using the new branch"
    env:
      ARM_CLIENT_ID: $(hana-pipeline-spn-id)
      ARM_CLIENT_SECRET: $(hana-pipeline-spn-pw)
      ARM_TENANT_ID: $(environment-tenant)
      ARM_SUBSCRIPTION_ID: $(environment-subscription)
