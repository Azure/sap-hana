---

- name: Installing OS packages
  package: 
    name: "{{ item }}" 
    state: present
  with_items: "{{ packages[ansible_os_family] }}"

- name: Enable and start tuned
  systemd:
     name: tuned
     state: started
     enabled: yes
  when: ansible_os_family == "RedHat"

- name:  Tuned profile
  command: "tuned-adm profile sap-hana"
  when: ansible_os_family == "RedHat"

- name: Disable SELinux
  selinux:
    state: disabled
  register: se_state
  when: ansible_os_family == "RedHat"

- name: Preconfigured SAP HANA settings
  command: "saptune solution apply HANA"
  when: ansible_os_family == "Suse"

- name:  enable tuned profile saptune
  command: "saptune daemon start"
  when: ansible_os_family == "Suse"

- name: SAP HANA NUMA configuration 
  copy:
    dest: /etc/sysctl.d/sap_hana.conf
    content: |
       kernel.numa_balancing=0
  when: ansible_os_family == "RedHat"

- name: Save sysctl.conf config
  command: sysctl -p /etc/sysctl.d/sap_hana.conf 
  when: ansible_os_family == "RedHat"

- name: Save sysctl.conf config
  command: sysctl -p /etc/sysctl.d/sap_hana.conf 
  when: ansible_os_family == "RedHat"

- name: Disable & numad service
  service:
     name: numad
     state: stopped
     enabled: no
  when: ansible_os_family == "RedHat"

- name: Create a symbolic link
  file:
    src: "{{ item.prop }}"
    dest: "{{ item.value }}"
    state: link
  with_items:
    - { prop: '/usr/lib64/libssl.so.10', value: '/usr/lib64/libssl.so.1.0.1' }
    - { prop: '/usr/lib64/libcrypto.so.10', value: '/usr/lib64/libcrypto.so.1.0.1' }
  when: ansible_os_family == "RedHat"

- name: Add always and never to transparent hugepages
  command: "echo never > /sys/kernel/mm/transparent_hugepage/enabled"

- name: Transparent_hugepage update to never and configure processor C-States
  lineinfile: 
     dest: /etc/default/grub 
     regexp: "GRUB_CMDLINE_LINUX=" 
     line: "GRUB_CMDLINE_LINUX='crashkernel=auto  @ vconsole.keymap=us @kernel_arguments: transparent_hugepage=never intel_idle.max_cstate=1 processor.max_cstate=1'"

- name: Modify transparent_hugepage
  command: grub2-mkconfig -o /boot/grub2/grub.cfg

- name: Processes for the SAPSYS
  copy:
    dest: /etc/security/limits.d/99-sapsys.conf
    content: |
       '@sapsys soft nproc unlimited'
       '@sapsys hard nproc unlimited'

- name: Disable and stop abrt-ccpp
  systemd:
     name: abrt-ccpp
     state: stopped
     enabled: no
  when: ansible_os_family == "RedHat"

- name: Disable and stop abrtd
  systemd:
     name: abrtd
     state: stopped
     enabled: no
  when: ansible_os_family == "RedHat"

- name: Disable core dumps for all users 
  lineinfile:
    dest: /etc/security/limits.conf
    line: "{{ item }}"
  with_items:
    - '* soft core 0'
    - '* hard core 0'

- name: Disable and stop kdump
  systemd:
     name: kdump.service
     state: stopped
     enabled: no
  when: ansible_os_family == "RedHat"

- name: Disable and stop firewall
  systemd:
     name: firewalld
     state: stopped
     enabled: no
  when: ansible_os_family == "RedHat"

- name: Reboot the machine if SELinux is disabled
  reboot:
  when: se_state.changed and ansible_os_family == 'RedHat'
