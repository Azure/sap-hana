---

- name: Add always and never to transparent hugepages
  command: "echo never > /sys/kernel/mm/transparent_hugepage/enabled"

- name: Transparent_hugepage update to never and configure processor C-States
  lineinfile: 
     dest: /etc/default/grub 
     regexp: "GRUB_CMDLINE_LINUX=" 
     line: "GRUB_CMDLINE_LINUX='crashkernel=auto  @ vconsole.keymap=us @kernel_arguments: transparent_hugepage=never intel_idle.max_cstate=1 processor.max_cstate=1'"

- name: Modify transparent_hugepage
  command: grub2-mkconfig -o /boot/grub2/grub.cfg

- name: Processes for the SAPSYS
  copy:
    dest: /etc/security/limits.d/99-sapsys.conf
    content: |
       '@sapsys soft nproc unlimited'
       '@sapsys hard nproc unlimited'

- name: Disable core dumps for all users 
  lineinfile:
    dest: /etc/security/limits.conf
    line: "{{ item }}"
  with_items:
    - '* soft core 0'
    - '* hard core 0'

- name: Set SWAP space
  lineinfile:
    dest: /etc/waagent.conf
    regexp: "^{{ item.prop }}="
    line: "{{ item.prop }}={{ item.value }}"
  with_items:
    - { prop: "ResourceDisk.Format", value: "y" }
    - { prop: "ResourceDisk.EnableSwap", value: "y" }
    - { prop: "ResourceDisk.SwapSizeMB", value: "{{ (hdb_sizes[output.databases | map(attribute='size')| join(',')].compute.swap_size_gb) * 1024|int }}" }

- name: restart waagnet
  service:
     name: waagent 
     state: restarted
