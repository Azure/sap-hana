- name: Get info about the security group that you had created
  azure_rm_securitygroup_facts:
    name: "{{ hana_nsg_name }}"
    resource_group: "{{ resource_group }}"
  register: nsg_info

- name: Get the current NSG rules
  set_fact:
    nsg_rules: "{{ nsg_info['ansible_facts']['azure_securitygroups'][0]['properties']['securityRules'] }}"

- debug:
    var: nsg_rules

- name: Create list of Ports to allow in new rules
  set_fact:
    dest_port_range: "{{ nsg_rules | map(attribute='properties.destinationPortRange') | list }}"

- debug:
    var: dest_port_range
- name: Get the ip addresses of the vms
  set_fact: allow_ip="{{ hostvars[item]['public_ip'] }}"
  with_items: "{{ groups['azure'] }}"
  register: allow_ips_result


- name: make a list
  set_fact: allow_ips="{{ allow_ips_result.results | map(attribute='ansible_facts.allow_ip') | list }}"

- debug:
    var: allow_ips

- name: Update NSG rules
  azure_rm_securitygroup:
    name: "{{ hana_nsg_name }}"
    resource_group: "{{ resource_group }}"
    rules:
        - name: AllowVMsIPs
          protocol: Tcp
          priority: 110
          source_address_prefix: "{{ allow_ips }}"
          destination_port_range: "{{ allow_ports }}"
